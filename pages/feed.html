<div class="preloader-wrapper active">
	<div class="spinner-layer spinner-red-only">
		<div class="circle-clipper left"><div class="circle"></div></div>
		<div class="gap-patch"><div class="circle"></div></div>
		<div class="circle-clipper right"><div class="circle"></div></div>
	</div>
</div>
<script type="text/javascript">
	this.vote = function(id, elem) {
		let disabled = elem.classList.contains("disabled")
		fetch(_app.make([
			"choices",
			id,
			disabled ? "unvote" : "vote",
		]), {
			headers: http.handlers.head(),
			method: "put",
		}).then(function(resp) {
			return resp.json()
		}).then(function(json) {
			for(let i=0; i<elem.parentNode.childElementCount; i++) {
				elem.parentNode.children[i].classList.remove("disabled")
				continue
			}
			if(!disabled) {
				elem.classList.add("disabled")
			}
			return json
		})
		return false
	}
	http.get(_app.make([
		"polls",
		"latest",
	]), function(data) {
		let self = document.querySelector("main")
		self.innerHTML = (`
			<div class="row">
				<div class="col s12 m6 l4 xl3" ></div>
				<div class="col s12 m6 l4 xl3" ></div>
				<div class="col s12 m6 l4 xl3" ></div>
				<div class="col s12 m6 l4 xl3" ></div>
			</div>
		`)
		self = self.querySelectorAll(".row .col")
		data.forEach(function(poll, i) {
			let options = ""
			for(let i=0; i<poll.choices.length; i++) {
				let self = poll.choices[i]
				options += `<a href="#"	onclick="return vote(${self.id}, this)"
					class="white red-text text-lighten-1 waves-effect waves-light btn"
					>${self.text}</a>`
				continue
			}
			self[i%4].innerHTML += (`
				<div class="poll">
					<div class="card red lighten-1">
						<div class="card-content white-text">
							<span class="card-title">${poll.title}</span>
							<p>${poll.description}</p>
							<p data-user=${poll.owner} ></p>
						</div>
						<div class=divider></div>
						<div class="card-action">
							${options}
						</div>
					</div>
				</div>
			`)
			return
		})
		document.querySelector("main").innerHTML += (`
			<div class="divider"></div>
			<a class="btn center" href="#!poll" >create</a>
			<a class="btn right" href="#!.1" >next</a>
		`)
		document.querySelector("main").querySelectorAll("[data-user]").forEach(function(e) {
			return http.get(_app.make([
				"users",
				e.dataset.user,
			]), function(data, resp) {
				e.innerHTML = "by: " + data.display_name
				return
			})
		})
		return
	})
</script>
